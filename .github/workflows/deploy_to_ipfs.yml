# .github/workflows/deploy_to_ipfs.yml
name: Jekyll Build & Deploy to Public IPFS Gateways

on:
  push:
    branches:
      - main  # ç•¶æ¨é€åˆ° main åˆ†æ”¯æ™‚è§¸ç™¼æ­¤å·¥ä½œæµç¨‹

jobs:
  deploy_ipfs:
    runs-on: ubuntu-latest

    steps:
      # 1. æª¢æŸ¥ç¨‹å¼ç¢¼
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # ç¢ºä¿æœ‰æ¬Šé™æ¨é€ CID æ–‡ä»¶

      # --- ğŸš€ è¤‡è£½æ‚¨ç¾æœ‰çš„ Jekyll æ§‹å»ºæµç¨‹ ---

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2' 
          bundler-cache: true 

      - name: Install dependencies
        run: |
          gem install bundler
          bundle install

      - name: Build Jekyll site
        run: |
          echo "ğŸ’¡ Starting Jekyll build..."
          JEKYLL_ENV=production bundle exec jekyll build --config _config.yml
          echo "âœ… Jekyll build complete. Files are in _site/."
      
      # --- Jekyll æ§‹å»ºæµç¨‹çµæŸ ---


      # 2. å£“ç¸® Jekyll è¼¸å‡ºæ–‡ä»¶ (æº–å‚™ä¸Šå‚³)
      - name: Compress website files
        id: compress
        run: |
          BUILD_DIR="_site"
          # æª¢æŸ¥ Jekyll è¼¸å‡ºç›®éŒ„æ˜¯å¦å­˜åœ¨
          if [ ! -d "$BUILD_DIR" ]; then
            echo "âŒ Jekyll build directory ($BUILD_DIR) not found. Exiting."
            exit 1
          fi
          
          # å°‡ _site ç›®éŒ„çš„å…§å®¹å£“ç¸®ç‚º site.tar.gz
          # -C _site ç¢ºä¿å£“ç¸®åŒ…å…§çš„è·¯å¾‘æ˜¯ç›¸å°æ ¹ç›®éŒ„çš„ (å³ä¸åŒ…å« _site/ å‰ç¶´)
          tar -czf site.tar.gz -C "$BUILD_DIR" .
          echo "âœ… Files compressed to site.tar.gz"

      # 3. å˜—è©¦è¼ªè©¢å¤šå€‹ IPFS ç¶²é—œä¸Šå‚³
      - name: Try uploading to multiple IPFS gateways
        id: ipfs_deploy # ä¿æŒ ID ä¸è®Š
        # é€™è£¡æˆ‘å€‘ä¸éœ€è¦ INFURA ç›¸é—œ ENV
        run: |
          # å…è¨±å–®å€‹å‘½ä»¤å¤±æ•—ï¼Œé˜²æ­¢æ•´å€‹è…³æœ¬å› å–®å€‹ curl å¤±æ•—è€Œä¸­æ–·
          set +e 
          
          # è¨­ç½®å¤šå€‹å…¬å…±ç¶²é—œçš„ /api/v0/add ç«¯é»
          GATEWAYS=(
            "https://ipfs.io/api/v0/add?wrap-with-directory=true"
            "https://dweb.link/api/v0/add?wrap-with-directory=true"
            "https://gateway.pinata.cloud/api/v0/add?wrap-with-directory=true"
            "https://ipfs.eternum.io/api/v0/add?wrap-with-directory=true"
          )
          
          SUCCESS=false
          NEW_CID=""
          GATEWAY_USED=""

          for GW_URL in "${GATEWAYS[@]}"; do
            echo "ğŸŒ Trying gateway: $GW_URL"
            # ä½¿ç”¨ curl ä¸Šå‚³ tar.gz æ–‡ä»¶ï¼Œä¸¦è«‹æ±‚ç¶²é—œè§£å£“ (wrap-with-directory)
            RESPONSE=$(curl -s -X POST -F "file=@site.tar.gz" "$GW_URL")
            
            # å¾ JSON éŸ¿æ‡‰ä¸­è§£æ CID (Hash)ï¼Œé€™æ˜¯ IPFS API çš„æ¨™æº–éŸ¿æ‡‰
            CID=$(echo "$RESPONSE" | grep -o '"Hash":"[^"]*"' | head -1 | cut -d':' -f2 | tr -d '"')

            if [ ! -z "$CID" ]; then
              echo "âœ… Uploaded successfully via ${GW_URL}"
              NEW_CID="$CID"
              # æå–åŸºç¤ç¶²é—œ URLï¼Œç”¨æ–¼æœ€çµ‚é€£çµ
              GATEWAY_USED=$(echo "$GW_URL" | sed 's#/api/v0/add.*##') 
              SUCCESS=true
              break
            else
              echo "âŒ Failed on ${GW_URL}, trying next..."
              # æ‰“å°å‡ºéŸ¿æ‡‰ä»¥å¹«åŠ©èª¿è©¦
              echo "Response was: $RESPONSE" 
            fi
            # å»ºè­°åœ¨é€™è£¡åŠ å…¥ 'sleep 5' ä»¥é¿å…ç¬é–“è§¸ç™¼é™æµ
            sleep 5 
          done

          if [ "$SUCCESS" = false ]; then
            echo "ğŸ’€ All gateways failed. Exiting."
            exit 1
          fi
          
          # å°‡ CID å’Œä½¿ç”¨çš„ç¶²é—œè¼¸å‡ºåˆ° GITHUB_OUTPUT
          echo "NEW_CID=$NEW_CID" >> $GITHUB_OUTPUT
          echo "GATEWAY_USED=$GATEWAY_USED" >> $GITHUB_OUTPUT

      # 4. æ›´æ–° CID æ­·å²å’Œæœ€æ–°é€£çµæ–‡ä»¶
      - name: Update CID History and Latest Link ğŸ“
        if: success() 
        env:
          # å¾ä¸Šä¸€å€‹æ­¥é©Ÿç²å– CID å’Œä½¿ç”¨çš„ç¶²é—œ
          NEW_CID: ${{ steps.ipfs_deploy.outputs.NEW_CID }} 
          GATEWAY_USED: ${{ steps.ipfs_deploy.outputs.GATEWAY_USED }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          LATEST_CID_FILE="CID_LATEST.md"
          HISTORY_CID_FILE="CID_HISTORY.md"
          # ä½¿ç”¨æˆåŠŸä¸Šå‚³çš„ç¶²é—œä½œç‚ºé€£çµå‰ç¶´
          CID_LINK="$GATEWAY_USED/ipfs/$NEW_CID" 
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          # æª¢æŸ¥ CID æ˜¯å¦æœ‰è®Šæ›´
          OLD_CID=""
          if [ -f $LATEST_CID_FILE ]; then
              OLD_CID=$(grep 'CID:' $LATEST_CID_FILE | head -1 | sed -e 's/.*`\([a-zA-Z0-9]*\)`/\1/')
          fi

          if [ "$NEW_CID" = "$OLD_CID" ]; then
              echo "CID ($NEW_CID) æœªè®Šæ›´ï¼Œç„¡éœ€æ¨é€æ–‡ä»¶ã€‚"
              exit 0 
          fi
          
          echo "ğŸ”‘ CID è®Šæ›´åµæ¸¬åˆ°ã€‚æ­£åœ¨æ›´æ–°æ–‡ä»¶..."

          # æ›´æ–° LATEST CID æ–‡ä»¶ (è¦†è“‹)
          cat > $LATEST_CID_FILE <<EOL
# ğŸŒ æœ€æ–° IPFS éƒ¨ç½²é€£çµ

---
### ğŸš€ æœ€æ–°éƒ¨ç½²
ğŸ“… **æ™‚é–“ (UTC):** \`${TIMESTAMP}\`
ğŸ†” **CID:** \`${NEW_CID}\`
ğŸ”— **è¨ªå•é€£çµ (via $GATEWAY_USED):** [é»æ“Šæ­¤è™•è¨ªå•]($CID_LINK)
EOL

          # æ›´æ–° CID æ­·å²æ–‡ä»¶ (Append ä¸¦æ’åºåˆ°æœ€å‰)
          NEW_ENTRY="---
### ğŸ“¦ éƒ¨ç½²æ–¼ $TIMESTAMP
* **CID:** \`${NEW_CID}\`
* **é€£çµ (via $GATEWAY_USED):** [è¨ªå•]($CID_LINK)"

          if [ ! -f $HISTORY_CID_FILE ]; then
              echo "# ğŸ“œ IPFS éƒ¨ç½²æ­·å²è¨˜éŒ„" > $HISTORY_CID_FILE
              echo "$NEW_ENTRY" >> $HISTORY_CID_FILE
          else
              TEMP_FILE=$(mktemp)
              tail -n +2 $HISTORY_CID_FILE > $TEMP_FILE 
              
              echo "# ğŸ“œ IPFS éƒ¨ç½²æ­·å²è¨˜éŒ„" > $HISTORY_CID_FILE
              echo "$NEW_ENTRY" >> $HISTORY_CID_FILE
              
              cat $TEMP_FILE >> $HISTORY_CID_FILE
              rm $TEMP_FILE
          fi
          
          # æäº¤å’Œæ¨é€æ›´æ”¹
          echo "æ­£åœ¨æäº¤å’Œæ¨é€ CID æ–‡ä»¶..."
          git add $LATEST_CID_FILE $HISTORY_CID_FILE
          git commit -m "ğŸ¤– [CI] Auto-update IPFS CID to $NEW_CID"
          git push

      # 5. é¡¯ç¤ºæœ€çµ‚é€£çµ
      - name: Show final deployed link
        if: success()
        run: echo "ğŸŒ Your site deployed via ${{ steps.ipfs_deploy.outputs.GATEWAY_USED }}/ipfs/${{ steps.ipfs_deploy.outputs.NEW_CID }}"
