name: Sync Jekyll to GitLab Pages

on:
  push:
    branches: [main]

jobs:
  sync-to-gitlab:
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout GitHub repo
        # æ‹‰å–æ•´å€‹å€‰åº«ï¼Œfetch-depth: 0 å°æ–¼åŒæ­¥å¾ˆé‡è¦
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: ğŸ”„ Deploy to GitLab
        run: |
          # è¨­ç½® Git èº«ä»½
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # ğŸš¨ æ ¸å¿ƒé‚è¼¯ï¼šURL ç·¨ç¢¼ï¼Œç¢ºä¿ Token å®‰å…¨å‚³è¼¸
          
          # 1. ç²å– Token ä¸¦é€²è¡Œ URL ç·¨ç¢¼
          # é€™æ˜¯ç‚ºäº†ç¢ºä¿ Token ä¸­çš„æ‰€æœ‰ç‰¹æ®Šå­—å…ƒéƒ½èƒ½è¢« Git æ­£ç¢ºè§£æ
          GITLAB_TOKEN_ENCODED=$(echo -n "${{ secrets.GITLAB_TOKEN }}" | xxd -p | sed 's/\(..\)/%\1/g')
          
          # 2. æ§‹å»ºæœ€çµ‚ URL (å‹™å¿…æ›¿æ› YOUR_GITLAB_USERNAME)
          GITLAB_REPO="https://xxyzyh:$GITLAB_TOKEN_ENCODED@gitlab.com/xxyzyh/my-blog.git"
          
          # 3. æ·»åŠ é ç¨‹å€‰åº«ä¸¦æ¨é€
          git remote add gitlab $GITLAB_REPO
          echo "ğŸš€ Pushing code to GitLab repository..."
          
          # å˜—è©¦æ¨é€
          git push --force --quiet gitlab main:main
          
          if [ $? -eq 0 ]; then
            echo "âœ… Synchronization complete!"
          else
            echo "âŒ Synchronization FAILED. Check credentials and protected branch settings."
            exit 1
          fi
