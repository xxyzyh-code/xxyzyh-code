name: Sync Jekyll to GitLab Pages

on:
  push:
    branches: [main]

jobs:
  sync-to-gitlab:
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout GitHub repo
        # æ‹‰å–æ•´å€‹å€‰åº«å…§å®¹
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: ğŸ”‘ Set up SSH Key for GitLab
        # ä½¿ç”¨å°ˆé–€çš„ Action å°å…¥ç§å¯†é‡‘é‘°
        uses: webfactory/ssh-agent@v0.9.1
        with:
          # ğŸš¨ å¼•ç”¨æˆ‘å€‘å‰›å‰›è¨­ç½®çš„ç§å¯†é‡‘é‘°
          ssh-private-key: ${{ secrets.GITLAB_SSH_PRIVATE_KEY }}
          # å…è¨± Git ä¿¡ä»» GitLab çš„ SSH æŒ‡ç´‹ï¼Œé¿å…é¦–æ¬¡é€£ç·šç¢ºèª
          known-hosts-path: '/dev/null' 
          
      - name: ğŸ”„ Deploy to GitLab via SSH
        run: |
          # è¨­ç½® Git èº«ä»½
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # ğŸš¨ é—œéµï¼šä½¿ç”¨ SSH URL é€²è¡Œæ¨é€
          # æ ¼å¼ï¼šgit@gitlab.com:user/repo.git
          GITLAB_REPO_SSH="git@gitlab.com:xxyzyh/my-blog.git"
          
          # æ·»åŠ é ç¨‹å€‰åº«ä¸¦æ¨é€
          git remote add gitlab "$GITLAB_REPO_SSH"
          echo "ğŸš€ Pushing entire GitHub repository to GitLab via SSH..."
          
          # å˜—è©¦æ¨é€
          # å¦‚æœ GitLab ä¸Šçš„ Deploy Key æ¬Šé™è¨­å®šæ­£ç¢ºï¼Œé€™æ¬¡å°±æœƒæˆåŠŸ
          git push --force gitlab main:main
          
          if [ $? -eq 0 ]; then
            echo "âœ… Synchronization complete! GitLab CI/CD should now start building your Jekyll site."
          else
            echo "âŒ Synchronization FAILED. Check SSH Key setup on both sides and GitLab Write Access."
            exit 1
          fi
