name: Sync Jekyll to GitLab Pages

on:
  push:
    branches: [main]

jobs:
  sync-to-gitlab:
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout GitHub repo
        # æ‹‰å–æ•´å€‹å€‰åº«ï¼Œfetch-depth: 0 å°æ–¼åŒæ­¥å¾ˆé‡è¦
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: ğŸ”„ Deploy to GitLab
        run: |
          # è¨­ç½® Git èº«ä»½
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # ğŸš¨ é—œéµè§£æ±ºæ–¹æ¡ˆï¼šä¸å°‡ Token æ‹¼æ¥åˆ° URL ä¸­
          # 1. å®šç¾© GitLab å€‰åº«çš„ä¹¾æ·¨ URL
          # æ›¿æ› xxyzyh/my-blog.git ç‚ºä½ çš„ç›®æ¨™å€‰åº«è·¯å¾‘
          GITLAB_REPO_CLEAN="https://gitlab.com/xxyzyh/my-blog.git"
          
          # 2. è¨­ç½® Gitlab å€‰åº«çš„èªè­‰è³‡è¨Š
          # ä½¿ç”¨ git config credential.helper è®“ Git è‡ªå‹•è™•ç†èªè­‰
          # æ³¨æ„ï¼šæˆ‘å€‘åœ¨é€™è£¡ä½¿ç”¨ printf "%s" ä¾†ç¢ºä¿ ${{ secrets.GITLAB_TOKEN }} 
          # è®Šæ•¸è¢«è¦–ç‚ºå–®ç´”çš„å­—ä¸²ï¼Œä¸æœƒåŒ…å«æ›è¡Œã€‚
          printf "%s" "${{ secrets.GITLAB_TOKEN }}" > gitlab_token.txt
          
          # 3. è¨­ç½® credential helperï¼Œè®“ Git ä½¿ç”¨ Token é€²è¡Œ HTTP åŸºæœ¬èªè­‰
          # æˆ‘å€‘å°‡ Token å€¼å‚³éçµ¦ä¸€å€‹åç‚º "GITLAB_TOKEN_AUTH" çš„ç’°å¢ƒè®Šæ•¸
          # ä¸¦ä¸”ä½¿ç”¨ä¸€å€‹è…³æœ¬ä¾†è¼¸å‡ºèªè­‰è³‡è¨Šçµ¦ Git
          git config credential.https://gitlab.com.helper "!f() { test \"\$1\" = get && echo \"password=$(cat gitlab_token.txt)\" && echo \"username=xxyzyh\"; }; f"
          
          # 4. æ·»åŠ é ç¨‹å€‰åº«ä¸¦æ¨é€ï¼ˆä½¿ç”¨ä¹¾æ·¨ URLï¼‰
          git remote add gitlab "$GITLAB_REPO_CLEAN"
          
          echo "ğŸš€ Pushing code to GitLab repository..."
          
          # å˜—è©¦æ¨é€
          git push --force --quiet gitlab main:main
          
          if [ $? -eq 0 ]; then
            echo "âœ… Synchronization complete!"
          else
            echo "âŒ Synchronization FAILED. Final check: GitLab PAT validity (must be one clean line)."
            exit 1
          fi
          
