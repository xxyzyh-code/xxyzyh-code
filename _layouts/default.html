---
---

<!doctype html>
{% include copyright.html %}
<html lang="{{ site.locale | replace: "_", "-" | default: "en" }}" class="no-js">
  <head>
    {% include head.html %}
    
    {% if page.permalink == '/music/' %}
    <link rel="stylesheet" href="/assets/css/theme.css">
    <link rel="stylesheet" href="/assets/css/custom_player.css">
    {% endif %}
    {% include head/custom.html %}
  </head>

  <body class="layout--{{ page.layout | default: layout.layout }}{% if page.classes or layout.classes %}{{ page.classes | default: layout.classes | join: ' ' | prepend: ' ' }}{% endif %}" dir="{% if site.rtl %}rtl{% else %}ltr{% endif %}">
    {% include_cached skip-links.html %}
    {% include_cached masthead.html %}

    <div class="initial-content">
      {{ content }}
      {% include after-content.html %}
    </div>

    {% if site.search == true %}
      <div class="search-content">
        {% include_cached search/search_form.html %}
      </div>
    {% endif %}

    <div id="footer" class="page__footer">
      <footer>
        {% include footer/custom.html %}
        {% include_cached footer.html %}
      </footer>
    </div>

    <div id="gamification-dashboard" class="gamification-dashboard">
    <div class="header" onclick="document.getElementById('game-content').classList.toggle('collapsed')">
        <span id="level-display">Level 0</span>
        <span class="daily-score-summary" id="daily-score-display">ä»Šæ—¥ç©åˆ†: 0 åˆ†</span>
        <span class="collapse-icon">â–¼</span>
    </div>
    
    <div id="game-content" class="content">
        
        <div class="score-row">
            <span id="total-score-display">ç¸½ç©åˆ†: 0 åˆ†</span>
        </div>

        <div class="progress-container">
            <div id="level-progress-bar" class="progress-bar"></div>
        </div>
        <div class="progress-text-row">
            <span class="level-label">å‡ç´šé€²åº¦</span>
            <span id="level-progress-text">(0 / 100)</span>
        </div>
        
        <div class="section-title">ğŸ† æˆ‘çš„å¾½ç« </div>
        <div id="achievement-list" class="achievement-list">
            </div>

    </div>
</div>

<div id="game-notification" class="game-notification">
    </div>
    {% include scripts.html %}

    <script type="module">
        import { initializeGamificationModule, addBlogScore } from '/assets/js/gamificationModule.js';
        
        // 1. åˆå§‹åŒ–æ¨¡çµ„ (å¿…é ˆå…ˆåŸ·è¡Œï¼Œæ‰èƒ½æ›´æ–° UI)
        document.addEventListener('DOMContentLoaded', initializeGamificationModule);

        // 2. åŒ¯å‡º addBlogScore åˆ°å…¨å±€ window (å¦‚æœå…¶ä»–åœ°æ–¹éœ€è¦ï¼Œä¿ç•™æ­¤è¡Œ)
        window.addBlogScore = addBlogScore;

        console.log("ç¨‹å¼å¤¥ä¼´: éŠæˆ²åŒ–æ¨¡çµ„å·²åœ¨ Base Layout ä¸­å•Ÿå‹•ã€‚");

        // ===========================================
        // ç¨‹å¼å¤¥ä¼´: é–±è®€è¨ˆåˆ†é‚è¼¯ (ç¢ºä¿åœ¨æ¨¡çµ„ç’°å¢ƒä¸­å•Ÿå‹•)
        // æ¢ä»¶æª¢æŸ¥å¿…é ˆä½¿ç”¨ Liquid åˆ¤æ–·æ˜¯å¦ç‚ºæ–‡ç« é é¢
        // ===========================================
        
        {% if page.layout == "post" or page.layout == "single" %}
        
            // Liquid è®Šæ•¸ (åœ¨ç·¨è­¯æ™‚ç¢ºå®š)
            const currentArticleId = '{{ page.url }}'; 
            const READ_LOG_KEY = 'read_log';
            let readLog = {};
            
            try {
                const savedLog = localStorage.getItem(READ_LOG_KEY);
                if (savedLog) {
                    readLog = JSON.parse(savedLog);
                }
            } catch (e) {
                console.error("è¼‰å…¥é–±è®€ç´€éŒ„å¤±æ•—:", e);
            }
            
            let isFirstReadSession = !readLog[currentArticleId];
            let readTimerInterval = null;
            let secondsAccumulator = 0; 
            
            function trackReadingTime() {
                secondsAccumulator++;
                
                // è¨ºæ–·æ—¥èªŒï¼šæª¢æŸ¥è¨ˆæ™‚å™¨æ˜¯å¦åœ¨é‹è¡Œ
                // console.log(`[æ–‡ç« è¨ˆæ™‚å™¨] ç´¯ç©ç§’æ•¸: ${secondsAccumulator}. é¦–æ¬¡é–±è®€: ${isFirstReadSession}`); 
                
                if (secondsAccumulator >= 60) {
                    // â­ï¸ é—œéµï¼šé€™è£¡ç›´æ¥ä½¿ç”¨ import é€²ä¾†çš„ addBlogScore å‡½æ•¸ï¼
                    const success = addBlogScore(isFirstReadSession); 
                    secondsAccumulator = 0;
                    
                    if (success) {
                        console.log(`é–±è®€è¨ˆåˆ†æˆåŠŸã€‚é¦–æ¬¡é–±è®€ç‹€æ…‹ (æ˜¯å¦å·²è¨ˆå…¥æ–‡ç« æ•¸): ${isFirstReadSession ? 'æ˜¯' : 'å¦'}`);
                        
                        if (isFirstReadSession) {
                            readLog[currentArticleId] = true;
                            localStorage.setItem(READ_LOG_KEY, JSON.stringify(readLog));
                            isFirstReadSession = false; 
                        }
                    } else {
                        console.log("é–±è®€ç©åˆ†å·²é”åˆ°æ¯æ—¥ä¸Šé™ï¼Œåœæ­¢è¨ˆæ™‚ã€‚");
                        stopTracking();
                    }
                }
            }
            
            function startTracking() {
                if (readTimerInterval === null) {
                    readTimerInterval = setInterval(trackReadingTime, 1000);
                    console.log("ç¨‹å¼å¤¥ä¼´: æ–‡ç« é–±è®€è¨ˆæ™‚å™¨å·²å•Ÿå‹•ã€‚");
                }
            }

            function stopTracking() {
                if (readTimerInterval !== null) {
                    clearInterval(readTimerInterval);
                    readTimerInterval = null;
                    secondsAccumulator = 0;
                    console.log("ç¨‹å¼å¤¥ä¼´: æ–‡ç« é–±è®€è¨ˆæ™‚å™¨å·²åœæ­¢ï¼Œç´¯ç©ç§’æ•¸å·²æ¸…é›¶ã€‚");
                }
            }
            
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible') {
                    startTracking();
                } else {
                    stopTracking();
                }
            });

            startTracking();
            window.addEventListener('beforeunload', stopTracking);
            
        {% endif %}
        
    </script>
    
  </body>
</html>
