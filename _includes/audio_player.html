<div id="custom-audio-player">
    <h3>æˆ‘çš„éŸ³æ¨‚æ’­æ”¾å™¨</h3>
    
    <audio id="main-audio" controls src="{{ site.data.music[0].url }}">
        æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒ HTML5 éŸ³é »ã€‚
    </audio>
    
<div id="player-controls">
    <span id="mode-button" onclick="togglePlayMode()">
        [ æ¨¡å¼: é †åº ]
    </span>
    
    <div id="theme-switcher">
    <button id="theme-toggle-btn">
        ä¸»é¡Œ (ç•¶å‰: <span id="current-theme-name">ç™½è‰² (è‡ªå‹•)</span>)
    </button>
<div id="theme-menu" class="hidden-menu">
    <span class="theme-option" data-theme="light">ç™½è‰²</span>
    <span class="theme-option" data-theme="dark">é»‘è‰²</span>
    <span class="theme-option" data-theme="grey">ç°è‰²</span>
    <span class="theme-option" data-theme="blue">è—è‰²</span>
    <span class="theme-option" data-theme="green">ç¶ è‰²</span>
    <span class="theme-option" data-theme="purple">ç´«è‰²</span>
    <span class="theme-option" data-theme="pink">ç²‰è‰²</span>
    <span class="theme-option" data-theme="red">ç´…è‰²</span>
</div>
</div>

    <div id="sleep-timer-area">
        <button id="timer-toggle-btn" onclick="toggleTimerMenu()">
            å®šæ™‚ (æœªè¨­å®š)
        </button>
        
        <div id="timer-menu" class="hidden-menu">
            <span class="menu-item" onclick="setSleepTimer(10)">10 åˆ†é˜å¾Œé—œé–‰</span>
            <span class="menu-item" onclick="setSleepTimer(30)">30 åˆ†é˜å¾Œé—œé–‰</span>
            <span class="menu-item" onclick="setSleepTimer(60)">60 åˆ†é˜å¾Œé—œé–‰</span>
            <span class="menu-item" onclick="clearSleepTimer(); toggleTimerMenu();">å–æ¶ˆå®šæ™‚</span>
        </div>
    </div>
</div> 

<div id="search-area">
    <input type="text" id="playlist-search" placeholder="ğŸ” æœå°‹æ­Œæ›²æˆ–æ­Œæ‰‹..." aria-label="æœå°‹æ­Œæ›²æˆ–æ­Œæ‰‹">
</div>
    
<div id="stats-bar">
    <span>ç¸½æ™‚é•·: <span id="total-listen-time">0 åˆ†é˜</span></span>
    <span>å‰©é¤˜: <span id="remaining-timer">--:--</span></span>
</div>
    
<ul id="playlist">

    {% for track in site.data.music %}
        <li data-url="{{ track.url }}" onclick="loadTrack('{{ track.url }}', '{{ track.title }}', {{ forloop.index0 }})">
            {{ track.title }} - {{ track.artist }}
        </li>
    {% endfor %}
    </ul>
</div>


<script>
// ç²å– DOM å…ƒç´ 
const audio = document.getElementById('main-audio');
const playerTitle = document.querySelector('#custom-audio-player h3');
const playlistItems = document.querySelectorAll('#playlist li'); 
const modeButton = document.getElementById('mode-button'); 

// æ–°å¢ DOM å…ƒç´ 
const timerToggleButton = document.getElementById('timer-toggle-btn');
const timerMenu = document.getElementById('timer-menu');
const totalListenTimeSpan = document.getElementById('total-listen-time');
const remainingTimerSpan = document.getElementById('remaining-timer');
// âœ… JSè®Šå‹•ï¼šæ–°å¢æœå°‹æ¡† DOM å…ƒç´ 
const playlistSearchInput = document.getElementById('playlist-search'); 

// *** ä¸»é¡Œåˆ‡æ›ç›¸é—œ DOM å…ƒç´  (é ‚å±¤å®šç¾©) ***
const themeToggleBtn = document.getElementById('theme-toggle-btn');
const themeMenu = document.getElementById('theme-menu');
const currentThemeName = document.getElementById('current-theme-name');
const themeOptions = document.querySelectorAll('#theme-menu .theme-option');
    
    
// 1. æº–å‚™æ•¸æ“šå’Œç‹€æ…‹è¿½è¹¤
const trackList = [
{% for track in site.data.music %}
    { title: "{{ track.title | escape }}", url: "{{ track.url | escape }}" },
{% endfor %}
];

let currentTrackIndex = 0; 
// æ’­æ”¾æ¨¡å¼ï¼š0=é †åº, 1=å¾ªç’°, 2=éš¨æ©Ÿ, 3=è‡ªç”±(æ’­å®Œå³åœ)
let playMode = 0; 

// å®šæ™‚å™¨ç‹€æ…‹è®Šæ•¸
let sleepTimerId = null; 
let sleepTime = 0; 
let endTime = 0; 
let countdownIntervalId = null; 

// ç¸½æ™‚é•·è¿½è¹¤è®Šæ•¸
let totalListenMinutes = 0;
let totalListenSeconds = 0;
let listenIntervalId = null; 


// --- è¼”åŠ©å‡½æ•¸ ---

// è¼‰å…¥ä¸¦æ’­æ”¾æŒ‡å®šç´¢å¼•çš„æ­Œæ›²
function playTrack(index) {
    if (index >= 0 && index < trackList.length) {
        currentTrackIndex = index;
        const track = trackList[index];
        audio.src = track.url;
        playerTitle.textContent = `æ­£åœ¨æ’­æ”¾ï¼š${track.title}`;
        audio.play().catch(error => {
            console.error("è‡ªå‹•æ’­æ”¾å¤±æ•—ï¼Œå¯èƒ½æ˜¯ç€è¦½å™¨é™åˆ¶ï¼š", error);
        });
        updatePlaylistHighlight();
    } else if (index === trackList.length) {
        audio.pause(); 
        playerTitle.textContent = "æ’­æ”¾åˆ—è¡¨å·²çµæŸ";
        currentTrackIndex = -1; 
        updatePlaylistHighlight();
    }
}

// ç²å–éš¨æ©Ÿç´¢å¼•
function getNextRandomIndex() {
    let newIndex;
    do {
        newIndex = Math.floor(Math.random() * trackList.length);
    } while (newIndex === currentTrackIndex && trackList.length > 1);
    
    return newIndex;
}

// æ›´æ–°æ’­æ”¾åˆ—è¡¨çš„é«˜äº®ç‹€æ…‹
function updatePlaylistHighlight() {
    playlistItems.forEach((item, index) => {
        item.classList.remove('playing');
        if (index === currentTrackIndex) {
            item.classList.add('playing');
        }
    });
}


// --- æ ¸å¿ƒé‚è¼¯ï¼šæ§åˆ¶æ’­æ”¾é †åº/å¾ªç’°/éš¨æ©Ÿ/è‡ªç”± ---

audio.addEventListener('ended', () => {
    if (playMode === 1) {
        audio.currentTime = 0; 
        audio.play();
    } else if (playMode === 2) {
        const nextIndex = getNextRandomIndex();
        playTrack(nextIndex);
    } else if (playMode === 3) {
        audio.pause();
        playerTitle.textContent = "è‡ªç”±æ¨¡å¼ä¸‹ï¼Œç•¶å‰æ­Œæ›²æ’­æ”¾å®Œç•¢ã€‚";
        currentTrackIndex = -1; 
        updatePlaylistHighlight();
    } 
    else {
        if (currentTrackIndex < trackList.length - 1) {
            playTrack(currentTrackIndex + 1); 
        } else {
            playTrack(trackList.length); 
        }
    }
});


// æ¨¡å¼åˆ‡æ›å‡½æ•¸
function togglePlayMode() {
    playMode = (playMode + 1) % 4; 
    
    let modeText;
    let titleMessage;
    
    if (playMode === 1) {
        modeText = "[ æ¨¡å¼: å¾ªç’° ]";
        titleMessage = "å·²åˆ‡æ›åˆ°å–®æ›²å¾ªç’°æ¨¡å¼";
    } else if (playMode === 2) {
        modeText = "[ æ¨¡å¼: éš¨æ©Ÿ ]";
        titleMessage = "å·²åˆ‡æ›åˆ°éš¨æ©Ÿæ’­æ”¾æ¨¡å¼";
    } else if (playMode === 3) {
        modeText = "[ æ¨¡å¼: è‡ªç”± ]";
        titleMessage = "å·²åˆ‡æ›åˆ°è‡ªç”±æ’­æ”¾æ¨¡å¼ (æ’­å®Œå³åœ)";
    } else {
        modeText = "[ æ¨¡å¼: é †åº ]";
        titleMessage = "å·²åˆ‡æ›åˆ°é †åºæ’­æ”¾æ¨¡å¼";
    }
    
    modeButton.textContent = modeText;
    playerTitle.textContent = titleMessage;

    // å„²å­˜æ’­æ”¾æ¨¡å¼åˆ° localStorage
    saveSettings(); 
}


// --- *** ä¸»é¡Œåˆ‡æ›é‚è¼¯ (é‡æ§‹ç‚ºå®Œå…¨æ‰‹å‹•åˆ‡æ›å„ªå…ˆ) *** ---

const THEME_STORAGE_KEY = 'userThemePreference';
const LIGHT_THEME = 'light'; // å…§éƒ¨æ¨™ç±¤ï¼šç™½è‰²
const DARK_THEME = 'dark';   // å…§éƒ¨æ¨™ç±¤ï¼šé»‘è‰²
const GREY_THEME = 'grey';   // å…§éƒ¨æ¨™ç±¤ï¼šç°è‰²
const BLUE_THEME = 'blue';
const GREEN_THEME = 'green';
const PURPLE_THEME = 'purple';
const PINK_THEME = 'pink';
const RED_THEME = 'red';
    
/**
 * è¨­ç½®ä¸»é¡Œé¡åä¸¦æ›´æ–°æŒ‰éˆ•é¡¯ç¤º
 * é€™æ˜¯ä¸»é¡Œçš„æ ¸å¿ƒå‡½æ•¸ï¼Œæ‰€æœ‰ä¸»é¡Œåˆ‡æ›éƒ½é€šéå®ƒ
 * @param {string} desiredTheme - 'light', 'dark', 'grey', 'blue', 'green' (ä½¿ç”¨è€…æ‰‹å‹•é¸æ“‡çš„æ„åœ–)
 * @param {boolean} isManual - æ˜¯å¦ç‚ºæ‰‹å‹•é¸æ“‡ (é»æ“Šèœå–®é¸é …æ™‚ç‚º true)
 */
function applyTheme(desiredTheme, isManual = false) {
    const body = document.body;
    let displayName = '';
    
    // 1. æ¸…é™¤æ‰€æœ‰ä¸»é¡Œé¡å (ç¢ºä¿åªæ‡‰ç”¨ä¸€å€‹ä¸»é¡Œ)
    body.classList.remove(
        DARK_THEME + '-theme', 
        GREY_THEME + '-theme',
        BLUE_THEME + '-theme',
        GREEN_THEME + '-theme',
        PURPLE_THEME + '-theme', // âœ… æ–°å¢æ¸…é™¤ç´«è‰²
        PINK_THEME + '-theme',   // âœ… æ–°å¢æ¸…é™¤ç²‰è‰²
        RED_THEME + '-theme'     // âœ… æ–°å¢æ¸…é™¤ç´…è‰²
    );

    let themeToApply = desiredTheme;
    let modeText = '(æ‰‹å‹•)'; 

    // 2. è™•ç†å„²å­˜/è‡ªå‹•æ¨¡å¼ (ä¿æŒä¸è®Š)
    if (isManual) {
        localStorage.setItem(THEME_STORAGE_KEY, desiredTheme);
    } 
    else if (desiredTheme === LIGHT_THEME) {
        themeToApply = getSystemThemeBasedOnTime();
        modeText = '(è‡ªå‹•)';
    }


    // 3. æ ¹æ“šæœ€çµ‚ç¢ºå®šçš„ä¸»é¡Œ themeToApply æ‡‰ç”¨é¡å
    if (themeToApply === DARK_THEME) {
        body.classList.add(DARK_THEME + '-theme');
        displayName = 'é»‘è‰²';
    } else if (themeToApply === GREY_THEME) {
        body.classList.add(GREY_THEME + '-theme');
        displayName = 'ç°è‰²';
    } else if (themeToApply === BLUE_THEME) {
        body.classList.add(BLUE_THEME + '-theme');
        displayName = 'è—è‰²';
    } else if (themeToApply === GREEN_THEME) {
        body.classList.add(GREEN_THEME + '-theme');
        displayName = 'ç¶ è‰²';
    } else if (themeToApply === PURPLE_THEME) { // âœ… è™•ç†ç´«è‰²
        body.classList.add(PURPLE_THEME + '-theme');
        displayName = 'ç´«è‰²';
    } else if (themeToApply === PINK_THEME) { // âœ… è™•ç†ç²‰è‰²
        body.classList.add(PINK_THEME + '-theme');
        displayName = 'ç²‰è‰²';
    } else if (themeToApply === RED_THEME) { // âœ… è™•ç†ç´…è‰²
        body.classList.add(RED_THEME + '-theme');
        displayName = 'ç´…è‰²';
    } else { 
        displayName = 'ç™½è‰²';
    }
    
    // 4. æ›´æ–°æŒ‰éˆ•é¡¯ç¤º
    currentThemeName.textContent = `${displayName} ${modeText}`;
}


/**
 * æ ¹æ“šç•¶åœ°æ™‚é–“åˆ¤æ–·æ‡‰è©²ä½¿ç”¨æ·ºè‰²é‚„æ˜¯æ·±è‰²
 * (å¤œé–“å®šç¾©ï¼š19:00 (å«) åˆ° 07:00 (ä¸å«))
 * @returns {string} 'dark' æˆ– 'light'
 */
function getSystemThemeBasedOnTime() {
    const hour = new Date().getHours();
    // æ™šä¸Š 19 é»åˆ°æ—©ä¸Š 7 é»ä¹‹é–“ä½¿ç”¨æ·±è‰² (é»‘è‰²)
    return (hour >= 19 || hour < 7) ? DARK_THEME : LIGHT_THEME;
}

/**
 * åˆå§‹åŒ–ä¸»é¡Œï¼šå¾ localStorage è®€å–æˆ–æ ¹æ“šæ™‚é–“è‡ªå‹•åˆ¤æ–·
 */
function initializeTheme() {
    const storedTheme = localStorage.getItem(THEME_STORAGE_KEY);
    
    // å¦‚æœå„²å­˜äº†ä»»æ„ä¸»é¡Œ (light, dark, grey)ï¼Œå‰‡æ‡‰ç”¨è©²ä¸»é¡Œä½œç‚ºæ‰‹å‹•é¸æ“‡
    if (storedTheme) {
        // å¦‚æœå„²å­˜çš„æ˜¯ lightï¼Œæˆ‘å€‘å°‡å…¶è¦–ç‚ºç”¨æˆ¶æœŸæœ›å›åˆ°è‡ªå‹•æ¨¡å¼
        if (storedTheme === LIGHT_THEME) {
             applyTheme(LIGHT_THEME, false); // false = è®“å®ƒé€²å…¥è‡ªå‹•åˆ¤æ–·
        } else {
             applyTheme(storedTheme, true); // true = æ‡‰ç”¨æ‰‹å‹•é¸æ“‡ (æ·±è‰²æˆ–ç°è‰²)
        }
    } else {
        // æ²’æœ‰å„²å­˜ï¼Œé è¨­ä½¿ç”¨è‡ªå‹•æ¨¡å¼
        applyTheme(LIGHT_THEME, false);
    }
}

// --- ä¸»é¡Œäº‹ä»¶ç›£è½å™¨ (æ–°å¢å’Œä¿®æ­£) ---

/**
 * é»æ“Šä¸»é¡Œåˆ‡æ›æŒ‰éˆ•ï¼Œåˆ‡æ›é¸å–®é¡¯ç¤º
 */
themeToggleBtn.addEventListener('click', (event) => {
    // é˜»æ­¢äº‹ä»¶å†’æ³¡ï¼Œé˜²æ­¢è¢« document é»æ“Šäº‹ä»¶ç«‹åˆ»é—œé–‰
    event.stopPropagation(); 
    // æ ¸å¿ƒé‚è¼¯ï¼šåˆ‡æ›éš±è—ç‹€æ…‹
    themeMenu.classList.toggle('hidden-menu');
});


// é»æ“Šé¸å–®é¸é …ï¼Œæ‡‰ç”¨æ–°çš„ä¸»é¡Œ
themeOptions.forEach(option => {
    option.addEventListener('click', (e) => {
        const selectedTheme = e.target.getAttribute('data-theme');
        // *** é—œéµä¿®æ­£ï¼šå°‡ isManual è¨­ç‚º trueï¼Œå¼·åˆ¶æ‡‰ç”¨è©²ä¸»é¡Œ ***
        applyTheme(selectedTheme, true); 
        // é¸æ“‡å¾Œè‡ªå‹•æ”¶èµ·èœå–®
        themeMenu.classList.add('hidden-menu'); 
    });
});


// ** BONUS: é»æ“Šé é¢å…¶ä»–åœ°æ–¹æ™‚ï¼Œéš±è—é¸å–® **
document.addEventListener('click', (e) => {
    // 1. è™•ç†ä¸»é¡Œèœå–® (ä¿æŒåŸæœ‰é‚è¼¯)
    if (!themeMenu.contains(e.target) && !themeToggleBtn.contains(e.target)) {
        themeMenu.classList.add('hidden-menu');
    }

    // 2. âœ… è™•ç†å®šæ™‚å™¨èœå–®
    // æª¢æŸ¥é»æ“Šæ˜¯å¦åœ¨å®šæ™‚å™¨èœå–®æˆ–å®šæ™‚å™¨æŒ‰éˆ•å…§éƒ¨
    if (!timerMenu.contains(e.target) && !timerToggleButton.contains(e.target)) {
        // åªæœ‰ç•¶èœå–®æ˜¯å±•é–‹ç‹€æ…‹ï¼ˆå³æ²’æœ‰ hidden-menu é¡ï¼‰æ™‚æ‰éœ€è¦å¼·åˆ¶é—œé–‰
        if (!timerMenu.classList.contains('hidden-menu')) {
            timerMenu.classList.add('hidden-menu');
        }
    }
});



// ** BONUS: å®šæœŸæª¢æŸ¥æ™‚é–“ä»¥æ‡‰å°è·¨è¶Šæ—¥å¤œçš„æ™‚é–“ (åƒ…ç”¨æ–¼è‡ªå‹•æ¨¡å¼) **
setInterval(() => {
    const storedTheme = localStorage.getItem(THEME_STORAGE_KEY);
    
    // åªæœ‰ç•¶å‰å„²å­˜çš„ä¸»é¡Œæ˜¯ 'light' (æ„åœ–ç‚ºè‡ªå‹•æ¨¡å¼) æ™‚ï¼Œæ‰éœ€è¦æ ¹æ“šæ™‚é–“è‡ªå‹•æ›´æ–°
    if (storedTheme === LIGHT_THEME) {
        // é‡æ–°åŸ·è¡Œè‡ªå‹•åˆ¤æ–·é‚è¼¯
        applyTheme(LIGHT_THEME, false); 
    }
}, 1000 * 60 * 60); // æ¯å°æ™‚æª¢æŸ¥ä¸€æ¬¡

    
    
// --- å®šæ™‚å™¨/çµ±è¨ˆé‚è¼¯ (ä¿æŒä¸è®Š) ---

function toggleTimerMenu() {
    timerMenu.classList.toggle('hidden-menu');
}

function setSleepTimer(minutes) {
    clearSleepTimer();
    toggleTimerMenu(); 

    const delayMilliseconds = minutes * 60 * 1000;
    
    sleepTime = minutes * 60;
    endTime = Date.now() + delayMilliseconds;

    sleepTimerId = setTimeout(() => {
        audio.pause(); 
        playerTitle.textContent = `å®šæ™‚å™¨åˆ°æœŸï¼Œå·²æš«åœæ’­æ”¾ (${minutes} åˆ†é˜)`;
        clearSleepTimer(); 
    }, delayMilliseconds);
    
    countdownIntervalId = setInterval(updateTimerCountdown, 1000);

    timerToggleButton.textContent = `å®šæ™‚ (${minutes} åˆ†é˜)`;
    playerTitle.textContent = `å®šæ™‚å™¨å·²è¨­ç½®ï¼š${minutes} åˆ†é˜å¾Œè‡ªå‹•é—œé–‰`;

    if (audio.paused) {
        audio.play();
    }
}

function clearSleepTimer() {
    if (sleepTimerId !== null) {
        clearTimeout(sleepTimerId);
        sleepTimerId = null;
    }
    if (countdownIntervalId !== null) {
        clearInterval(countdownIntervalId);
        countdownIntervalId = null;
    }
    
    sleepTime = 0;
    endTime = 0;
    timerToggleButton.textContent = "å®šæ™‚ (æœªè¨­å®š)";
    remainingTimerSpan.textContent = "--:--";
    playerTitle.textContent = "å·²å–æ¶ˆå®šæ™‚å™¨";
}

/**
 * æ›´æ–°å€’æ•¸è¨ˆæ™‚é¡¯ç¤ºï¼ŒåŸºæ–¼ç›®æ¨™çµæŸæ™‚é–“ (endTime) è¨ˆç®—
 */
function updateTimerCountdown() {
    if (endTime > 0) {
        // é—œéµä¿®æ­£ï¼šè¨ˆç®—ç•¶å‰æ™‚é–“èˆ‡ç›®æ¨™æ™‚é–“çš„ç²¾ç¢ºå·®å€¼
        const remainingMs = endTime - Date.now();
        
        // ç¢ºä¿å‰©é¤˜æ™‚é–“ä¸ç‚ºè² æ•¸
        const remainingS = Math.max(0, Math.floor(remainingMs / 1000));
        
        const minutes = Math.floor(remainingS / 60);
        const seconds = remainingS % 60;
        
        remainingTimerSpan.textContent = 
            `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            
        // å¦‚æœæ™‚é–“åˆ°æœŸï¼Œæ¸…é™¤è¨ˆæ™‚å™¨
        if (remainingS === 0) {
            clearSleepTimer(); 
            
            // å¦‚æœå€’æ•¸è¨ˆæ™‚å·²ç¶“çµæŸï¼Œæˆ‘å€‘ä¹Ÿæ‡‰è©²åœæ­¢éŸ³é »
            // é›–ç„¶å®šæ™‚å™¨åˆ°æœŸé‚è¼¯åœ¨ setTimeout è£¡ï¼Œé€™è£¡å¢åŠ ä¸€å€‹ä¿éšª
            if (!audio.paused) {
                 audio.pause();
                 playerTitle.textContent = `å®šæ™‚å™¨åˆ°æœŸï¼Œå·²æš«åœæ’­æ”¾`;
            }
        }
    }
}


audio.addEventListener('play', () => {
    if (listenIntervalId === null) {
        listenIntervalId = setInterval(updateTotalListenTime, 1000);
    }
});

audio.addEventListener('pause', () => {
    if (listenIntervalId !== null) {
        clearInterval(listenIntervalId);
        listenIntervalId = null;
    }
});

function updateTotalListenTime() {
    totalListenSeconds++;
    if (totalListenSeconds >= 60) {
        totalListenMinutes++;
        totalListenSeconds = 0;
    }
    
    totalListenTimeSpan.textContent = 
        `${totalListenMinutes} åˆ†é˜ ${totalListenSeconds} ç§’`;
}


// --- å¤–éƒ¨å‘¼å«å‡½æ•¸ (ä¾†è‡ªåˆ—è¡¨é»æ“Š) ---

function loadTrack(url, title, index) {
    // é»æ“Šåˆ—è¡¨å¾Œï¼Œè‡ªå‹•åˆ‡æ›åˆ°ã€Œè‡ªç”±æ¨¡å¼ã€ (Mode 3)
    if (playMode !== 3) {
        playMode = 3;
        modeButton.textContent = "[ æ¨¡å¼: è‡ªç”± ]";
        playerTitle.textContent = "å·²åˆ‡æ›åˆ°è‡ªç”±æ’­æ”¾æ¨¡å¼ (é»æ“Šåˆ—è¡¨)";
        // *** æ–°å¢ï¼šå„²å­˜æ’­æ”¾æ¨¡å¼åˆ° localStorage ***
        saveSettings(); 
    }
    playTrack(index);
}


// --- *** LocalStorage é‚è¼¯ (æŒä¹…åŒ–ï¼šæ¨¡å¼/ä¸»é¡Œ/éŸ³é‡/éœéŸ³/é€²åº¦) *** ---

// âœ… æ–°å¢ï¼šLocalStorage éµ
const CURRENT_TRACK_INDEX_KEY = 'audioPlayerIndex';
const CURRENT_TRACK_TIME_KEY = 'audioPlayerTime';

// å„²å­˜ç•¶å‰éŸ³é‡ã€éœéŸ³ç‹€æ…‹ã€æ¨¡å¼ã€ç´¢å¼•å’Œé€²åº¦
function saveSettings() {
    try {
        // ä¿å­˜éŸ³é‡å€¼å’ŒéœéŸ³ç‹€æ…‹
        localStorage.setItem('audioPlayerVolume', audio.volume);
        localStorage.setItem('audioPlayerMuted', audio.muted);
        
        // ä¿å­˜æ’­æ”¾æ¨¡å¼
        localStorage.setItem('audioPlayerMode', playMode);

        // âœ… æ–°å¢ï¼šä¿å­˜ç•¶å‰æ’­æ”¾çš„æ›²ç›®ç´¢å¼•
        if (currentTrackIndex >= 0) {
            localStorage.setItem(CURRENT_TRACK_INDEX_KEY, currentTrackIndex);
        } else {
            localStorage.removeItem(CURRENT_TRACK_INDEX_KEY); // æ¸…é™¤ç´¢å¼•ï¼Œè¡¨ç¤ºåˆ—è¡¨çµæŸ
        }

        // âœ… æ–°å¢ï¼šä¿å­˜ç•¶å‰æ’­æ”¾æ™‚é–“ï¼ˆç§’æ•¸ï¼‰
        if (audio.currentTime > 0) {
             // åªæœ‰æœ‰é€²åº¦æ™‚æ‰å„²å­˜æ™‚é–“
             localStorage.setItem(CURRENT_TRACK_TIME_KEY, audio.currentTime);
        } else {
             // å¦‚æœæ²’æœ‰æ’­æ”¾é€²åº¦ (ä¾‹å¦‚ currentTime=0)ï¼Œå‰‡æ¸…é™¤
             localStorage.removeItem(CURRENT_TRACK_TIME_KEY);
        }
        
    } catch (e) {
        console.warn('LocalStorage is not available or blocked.', e);
    }
}

// å¾å„²å­˜ä¸­è¼‰å…¥éŸ³é‡ã€éœéŸ³ç‹€æ…‹ã€æ¨¡å¼ã€ç´¢å¼•å’Œé€²åº¦
function loadSavedSettings() {
    try {
        // è¼‰å…¥éŸ³é‡å’ŒéœéŸ³ç‹€æ…‹
        const savedVolume = localStorage.getItem('audioPlayerVolume');
        if (savedVolume !== null) {
            audio.volume = Math.max(0, Math.min(1, parseFloat(savedVolume)));
        }
        const savedMuted = localStorage.getItem('audioPlayerMuted');
        if (savedMuted !== null) {
            audio.muted = (savedMuted === 'true');
        }

        // è¼‰å…¥æ¨¡å¼
        const savedMode = localStorage.getItem('audioPlayerMode');
        if (savedMode !== null) {
            const mode = parseInt(savedMode);
            if (mode >= 0 && mode <= 3) {
                playMode = mode;
                updateModeUI(); 
            }
        }
        
        // âœ… æ–°å¢ï¼šè¼‰å…¥æ›²ç›®ç´¢å¼•
        const savedIndex = localStorage.getItem(CURRENT_TRACK_INDEX_KEY);
        if (savedIndex !== null) {
            const index = parseInt(savedIndex);
            if (index >= 0 && index < trackList.length) {
                currentTrackIndex = index;
                // å¿…é ˆå…ˆè¼‰å…¥æ›²ç›®ï¼Œæ‰èƒ½è¨­å®šæ™‚é–“
                const track = trackList[index];
                audio.src = track.url;
                playerTitle.textContent = `ä¸Šæ¬¡æ’­æ”¾ï¼š${track.title}`;
            }
        }

        // âœ… æ–°å¢ï¼šè¼‰å…¥æ’­æ”¾æ™‚é–“é€²åº¦
        const savedTime = localStorage.getItem(CURRENT_TRACK_TIME_KEY);
        // åªæœ‰ç•¶æ›²ç›®ç´¢å¼•æˆåŠŸè¼‰å…¥æ™‚ï¼Œæ‰å˜—è©¦è¼‰å…¥æ™‚é–“
        if (savedTime !== null && currentTrackIndex >= 0) { 
             const time = parseFloat(savedTime);
             if (!isNaN(time) && time > 0) {
                 audio.currentTime = time;
             }
             // ç„¡è«–æ˜¯å¦æˆåŠŸè¼‰å…¥ï¼Œæ’­æ”¾é€²åº¦åœ¨è¼‰å…¥å¾Œå°±æ‡‰è©²è¢«æ¸…é™¤
             // é€™æ¨£å¯ä»¥ç¢ºä¿ç”¨æˆ¶åœ¨è½å®Œå¾Œé—œé–‰é é¢ï¼Œä¸‹æ¬¡ä¸æœƒè·³åˆ°æ­Œæ›²ä¸­æ®µ
             localStorage.removeItem(CURRENT_TRACK_TIME_KEY); 
        }
        
    } catch (e) {
        console.warn('Failed to load settings from LocalStorage.', e);
    }
}

// å°ˆé–€ç”¨æ–¼è¼‰å…¥è¨­å®šæ™‚æ›´æ–°æ¨¡å¼ UI 
function updateModeUI() {
    let modeText;
    if (playMode === 1) {
        modeText = "[ æ¨¡å¼: å¾ªç’° ]";
    } else if (playMode === 2) {
        modeText = "[ æ¨¡å¼: éš¨æ©Ÿ ]";
    } else if (playMode === 3) {
        modeText = "[ æ¨¡å¼: è‡ªç”± ]";
    } else {
        modeText = "[ æ¨¡å¼: é †åº ]";
    }
    modeButton.textContent = modeText;
}

// âœ… æ–°å¢ï¼šæœå°‹/ç¯©é¸é‚è¼¯
/**
 * æ ¹æ“šæœå°‹æ¡†çš„è¼¸å…¥å…§å®¹ï¼Œç¯©é¸ä¸¦é¡¯ç¤º/éš±è—æ’­æ”¾åˆ—è¡¨é …ç›®
 */
function filterPlaylist() {
    // å°‡è¼¸å…¥è½‰ç‚ºå°å¯«ï¼Œæ–¹ä¾¿ä¸å€åˆ†å¤§å°å¯«çš„åŒ¹é…
    const searchText = playlistSearchInput.value.toLowerCase(); 

    playlistItems.forEach(item => {
        // ç²å–åˆ—è¡¨é …çš„å®Œæ•´æ–‡å­—å…§å®¹ (æ­Œå - æ­Œæ‰‹)
        const itemText = item.textContent.toLowerCase(); 

        if (itemText.includes(searchText)) {
            // å¦‚æœåˆ—è¡¨é …åŒ…å«æœå°‹æ–‡å­—ï¼Œå‰‡é¡¯ç¤ºå®ƒ
            item.style.display = ''; // æ¢å¾©é è¨­é¡¯ç¤ºæ¨£å¼
        } else {
            // å¦å‰‡éš±è—å®ƒ
            item.style.display = 'none';
        }
    });
}


// --- *** äº‹ä»¶ç›£è½å™¨å€å¡Š (åº•éƒ¨åˆå§‹åŒ–ä¹‹å‰) *** ---

// ç›£è½éŸ³é‡è®Šæ›´å’ŒéœéŸ³ç‹€æ…‹è®Šæ›´äº‹ä»¶ï¼Œä»¥ä¾¿å„²å­˜
// *** ä¿®æ­£ï¼šéŸ³é‡å’ŒéœéŸ³ç‹€æ…‹è®Šæ›´éƒ½å‘¼å« saveSettings ***
audio.addEventListener('volumechange', saveSettings);
audio.addEventListener('ratechange', saveSettings); // æŸäº›ç€è¦½å™¨å¯èƒ½éœ€è¦
audio.addEventListener('loadedmetadata', saveSettings); // é¦–æ¬¡è¼‰å…¥ metadata å¾Œå„²å­˜ä¸€æ¬¡

// âœ… æ–°å¢ï¼šå¯¦æ™‚ä¿å­˜é€²åº¦ (æ¯ 5 ç§’ä¿å­˜ä¸€æ¬¡ï¼Œé¿å…é »ç¹å¯«å…¥)
audio.addEventListener('timeupdate', () => {
    if (!audio.paused && audio.currentTime % 5 < 1) {
         saveSettings();
    }
});

// ç¢ºä¿ç•¶æ­Œæ›²åˆ‡æ›/æš«åœ/çµæŸæ™‚ï¼Œæ–°çš„ç´¢å¼•å’Œæ™‚é–“è¢«ä¿å­˜
audio.addEventListener('play', saveSettings);
audio.addEventListener('pause', saveSettings);
audio.addEventListener('ended', saveSettings);

// âœ… æ–°å¢ï¼šæœå°‹äº‹ä»¶ç›£è½å™¨ (ç›£è½è¼¸å…¥æ¡†çš„ input äº‹ä»¶)
playlistSearchInput.addEventListener('input', filterPlaylist);


// --- åˆå§‹åŒ– (å·²å°‡ initializeTheme ç§»è‡³æ­¤è™•) ---

// 1. è¼‰å…¥å„²å­˜çš„è¨­å®šï¼ˆå¿…é ˆåœ¨åˆå§‹åŒ–æ™‚ç¬¬ä¸€æ­¥åŸ·è¡Œï¼‰
loadSavedSettings();

// *** 2. åˆå§‹åŒ–ä¸»é¡Œè¨­å®š (è‡ªå‹•æˆ–æ‰‹å‹•) ***
initializeTheme();

// 3. è¼‰å…¥ä¸¦é«˜äº®ç¬¬ä¸€é¦–æ­Œ
updatePlaylistHighlight(); 

// 4. ç¢ºä¿æ¨¡å¼ UI åœ¨è¼‰å…¥å¾Œæ˜¯æ­£ç¢ºçš„ï¼ˆå¦‚æœ loadSavedSettings æ›´æ”¹äº† playModeï¼‰
//    updateModeUI(); // å·²åŒ…å«åœ¨ loadSavedSettings å…§éƒ¨
</script>
